<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Flip‑Disc Orchestrator</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header>
      <strong>Flip‑Disc Orchestrator</strong>
    </header>
    <main>
      <section>
        <h2>Active Source</h2>
        <div class="row">
          <label for="source">Worker:</label>
          <select id="source"></select>
          <button id="activate">Set Active</button>
          <button id="restart">Restart Active</button>
          <button id="stop">Stop Active</button>
          <span id="active" class="muted"></span>
        </div>
        <div class="row">
          <span id="running" class="muted"></span>
        </div>
      </section>

      <section>
        <h2>Video Feed</h2>
        <div class="row">
          <button id="refreshConfig" class="sm">Refresh</button>
          <span id="cfg" class="muted"></span>
        </div>
        <div class="row controls check-row">
          <label>FPS: <input id="fpsInput" class="w-sm" type="number" min="1" max="120" value="30"/></label>
          <button id="fpsApply" class="sm">Apply</button>
          <span id="fpsMsg" class="muted"></span>
          <span class="muted">|</span>
          <label>Scale: <input id="previewScale" class="w-sm" type="number" min="1" max="64" value="10"/></label>
          <span class="muted">|</span>
          <label><input id="pipe_invert" type="checkbox"/> Invert</label>
          <label><input id="pipe_fliph" type="checkbox"/> Flip H</label>
          <label><input id="pipe_flipv" type="checkbox"/> Flip V</label>
          <label><input id="pipe_rot" type="checkbox"/> 180°</label>
          <button id="pipeApply" class="sm">Apply</button>
        </div>
        <div class="row">
          <img id="previewFrame" alt="Live preview" style="border:1px solid #ccc; image-rendering: pixelated; max-width: 100%" />
        </div>
      </section>

      <section id="panel-text-scroll" style="display:none">
        <h2>Text</h2>
        <div class="row">
          <label>Text: <input id="txt_text" type="text" size="30" placeholder="HELLO FLIP-DISC"/></label>
          <label>PPS: <input id="txt_pps" type="number" step="0.1" value="10"/></label>
          <label>Letter Spacing: <input id="txt_spacing" type="number" step="1" min="0" value="1"/></label>
          <button id="txt_apply">Apply</button>
          <span class="muted">Worker id: <code>text</code></span>
        </div>
      </section>

      <section id="panel-simplex-noise" style="display:none">
        <h2>Simplex Noise</h2>
        <div class="row">
          <label>Scale: <input id="sn_scale" type="number" min="1" max="128" value="4" style="width:80px"/></label>
          <label>Step: <input id="sn_step" type="number" step="0.01" min="0" value="0.05" style="width:100px"/></label>
          <label>Threshold: <input id="sn_threshold" type="number" min="0" max="255" value="128" style="width:90px"/></label>
          <label>Seed: <input id="sn_seed" type="number" step="1" value="" style="width:110px"/></label>
          <label><input id="sn_invert" type="checkbox"/> Invert</label>
          <button id="sn_apply">Apply</button>
          <span class="muted">Worker id: <code>simplex-noise</code></span>
        </div>
      </section>

      <section>
        <h2>Stats</h2>
        <div class="row">
          <button id="refreshStats">Refresh</button>
        </div>
        <table>
          <tbody id="stats"></tbody>
        </table>
      </section>

      <section>
        <h2>Errors</h2>
        <div id="errors" class="muted">No errors</div>
      </section>
    </main>
    <script>
      const sel = document.getElementById('source');
      const btn = document.getElementById('activate');
      const btnStop = document.getElementById('stop');
      const btnRestart = document.getElementById('restart');
      const active = document.getElementById('active');
      const statsT = document.getElementById('stats');
      const cfgEl = document.getElementById('cfg');
      const refreshStatsBtn = document.getElementById('refreshStats');
      const refreshCfgBtn = document.getElementById('refreshConfig');
      const txtText = document.getElementById('txt_text');
      const txtPps = document.getElementById('txt_pps');
      const txtApply = document.getElementById('txt_apply');
      const txtSpacing = document.getElementById('txt_spacing');
      const snScale = document.getElementById('sn_scale');
      const snStep = document.getElementById('sn_step');
      const snThreshold = document.getElementById('sn_threshold');
      const snSeed = document.getElementById('sn_seed');
      const snInvert = document.getElementById('sn_invert');
      const snApply = document.getElementById('sn_apply');
      const panelTextScroll = document.getElementById('panel-text-scroll');
      const panelSimplex = document.getElementById('panel-simplex-noise');
      const previewImg = document.getElementById('previewFrame');
      const previewScale = document.getElementById('previewScale');
      const fpsInput = document.getElementById('fpsInput');
      const fpsApply = document.getElementById('fpsApply');
      const fpsMsg = document.getElementById('fpsMsg');
      const pipeInvert = document.getElementById('pipe_invert');
      const pipeFlipH = document.getElementById('pipe_fliph');
      const pipeFlipV = document.getElementById('pipe_flipv');
      const pipeRot = document.getElementById('pipe_rot');
      const pipeApply = document.getElementById('pipeApply');

      async function getJSON(path){ const response = await fetch(path); return response.json(); }

      let lastUserSelectTs = 0;

      let lastSelectedId = null;
      async function refreshSources(){
        const sourcesJson = await getJSON('/sources');
        const activeJson = await getJSON('/active');
        // Keep current selection if possible
        const currentSel = sel.value || lastSelectedId;
        sel.innerHTML = '';
        const set = new Set([...(sourcesJson.known || []), ...(sourcesJson.sources || [])]);
        Array.from(set).forEach(id => {
          const opt = document.createElement('option');
          opt.value = id; opt.textContent = id; sel.appendChild(opt);
        });
        active.textContent = activeJson.active ? `Current: ${activeJson.active}` : 'No active source';
        const runningEl = document.getElementById('running');
        runningEl.textContent = (a.running && a.running.length) ? `Running: ${a.running.join(', ')}` : 'Running: (none)';
        const now = Date.now();
        const recentlySelecting = (document.activeElement === sel) && ((now - lastUserSelectTs) < SELECT_INTERACT_MS);
        const has = (id) => id && [...sel.options].some(o => o.value === id);
        if (recentlySelecting) {
          // While user is interacting, keep their selection stable
          if (has(currentSel)) sel.value = currentSel;
        } else {
          // Otherwise reflect active if any; else keep last user selection
          if (has(activeJson.active)) sel.value = activeJson.active;
          else if (has(currentSel)) sel.value = currentSel;
        }
        updatePanels();
      }

      function updatePanels(){
        const id = sel.value || '';
        if (panelTextScroll) panelTextScroll.style.display = (id === 'text') ? '' : 'none';
        if (panelSimplex) panelSimplex.style.display = (id === 'simplex-noise-js') ? '' : 'none';
      }

      async function setActive(){
        const id = sel.value || null;
        await fetch('/active',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
        await refreshSources();
      }
      async function stopActive(){
        await fetch('/active',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:null})});
        await refreshSources();
      }
      async function restartActive(){
        const activeJson = await getJSON('/active');
        const id = activeJson.active || null;
        if (!id) return;
        await fetch(`/workers/${id}/stop`, { method:'POST' });
        await fetch(`/workers/${id}/start`, { method:'POST' });
        await refreshSources();
      }

      async function refreshStats(){
        const statsJson = await getJSON('/stats');
        statsT.innerHTML = '';
        Object.entries(statsJson).forEach(([k,v]) => {
          const tr = document.createElement('tr');
          const td1 = document.createElement('td'); td1.textContent = k;
          const td2 = document.createElement('td'); td2.textContent = (typeof v==='object')? JSON.stringify(v): String(v);
          tr.append(td1, td2); statsT.appendChild(tr);
        })
        // Render errors summary
        const errs = statsJson.errors || {};
        const errKeys = Object.keys(errs);
        const el = document.getElementById('errors');
        if (errKeys.length === 0) {
          el.textContent = 'No errors';
        } else {
          const ul = document.createElement('ul');
          errKeys.forEach(id => {
            const li = document.createElement('li');
            li.textContent = `${id}: ${errs[id]}`;
            ul.appendChild(li);
          });
          el.replaceChildren(ul);
          el.classList.remove('muted');
        }
      }

      async function refreshConfig(){
        const configJson = await getJSON('/config');
        cfgEl.textContent = `Canvas ${configJson.canvas?.width}×${configJson.canvas?.height}, FPS ${configJson.fps}`;
        if (typeof setPreviewFps === 'function') setPreviewFps(configJson.fps || 30);
        try { fpsInput.value = String(configJson.fps || 30); } catch {}
      }

      // Preview constants
      const SELECT_INTERACT_MS = 1500;
      const PREVIEW_SCALE_MIN = 1;
      const PREVIEW_SCALE_MAX = 64;
      const PREVIEW_FPS_MAX = 60;
      const DEFAULT_PREVIEW_SCALE = 10;

      let previewTimer = null;
      function tickPreview(){
        const ts = Date.now();
        const raw = Number(previewScale.value) || DEFAULT_PREVIEW_SCALE;
        const scale = Math.max(PREVIEW_SCALE_MIN, Math.min(PREVIEW_SCALE_MAX, raw));
        previewImg.src = `/frame.png?scale=${scale}&ts=${ts}`; // ts busts cache
      }
      function setPreviewFps(fps){
        if (previewTimer) clearInterval(previewTimer);
        const previewFps = Math.max(1, Math.min(PREVIEW_FPS_MAX, Number(fps) || 2));
        const interval = Math.round(1000 / previewFps);
        tickPreview();
        previewTimer = setInterval(tickPreview, interval);
      }

      // Persist preview scale across reloads
      try {
        const saved = localStorage.getItem('previewScale');
        if (saved) previewScale.value = String(Math.max(PREVIEW_SCALE_MIN, Math.min(PREVIEW_SCALE_MAX, Number(saved)||DEFAULT_PREVIEW_SCALE)));
      } catch {}
      previewScale.addEventListener('change', () => {
        try { localStorage.setItem('previewScale', String(previewScale.value)); } catch {}
      });

      async function applyFps(){
        const fps = Number(fpsInput.value) || 0;
        const res = await fetch('/fps', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fps }) });
        if (!res.ok) {
          const txt = await res.text();
          fpsMsg.textContent = txt || 'Failed to set FPS';
        } else {
          fpsMsg.textContent = '';
          await refreshConfig();
        }
      }

      btn.addEventListener('click', setActive);
      sel.addEventListener('change', () => { lastUserSelectTs = Date.now(); lastSelectedId = sel.value; updatePanels(); loadWorkerConfig(); });
      btnStop.addEventListener('click', stopActive);
      btnRestart.addEventListener('click', restartActive);
      refreshStatsBtn.addEventListener('click', refreshStats);
      refreshCfgBtn.addEventListener('click', refreshConfig);
      fpsApply.addEventListener('click', applyFps);
      async function applyPipeline(){
        const id = sel.value || null;
        if (!id) return;
        const body = {
          invert: !!pipeInvert.checked,
          flip_h: !!pipeFlipH.checked,
          flip_v: !!pipeFlipV.checked,
          rotate180: !!pipeRot.checked,
        };
        await fetch(`/workers/${id}/config`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      }
      pipeApply.addEventListener('click', applyPipeline);

      async function applyTextCfg(){
        const id = sel.value || 'text';
        const spacing = Math.max(0, Number(txtSpacing.value)||1);
        const body = { text: txtText.value || 'HELLO FLIP-DISC', pps: Number(txtPps.value)||10, letter_spacing: spacing };
        await fetch(`/workers/${id}/config`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      }

      txtApply.addEventListener('click', applyTextCfg);

      async function applyNoiseCfg(){
        const id = sel.value || 'simplex-noise';
        const scale = Math.max(1, Number(snScale.value)||4);
        const step = Math.max(0, Number(snStep.value)||0.05);
        const threshold = Math.max(0, Math.min(255, Number(snThreshold.value)||128));
        const invert = !!snInvert.checked;
        const seedVal = Number(snSeed.value);
        const body = { scale, step, threshold, invert, seed: Number.isFinite(seedVal) ? seedVal : undefined };
        await fetch(`/workers/${id}/config`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      }

      snApply.addEventListener('click', applyNoiseCfg);

      async function loadWorkerConfig(){
        const id = sel.value || '';
        if (!id) return;
        try {
          const cfg = await getJSON(`/workers/${id}/config`);
          if (id === 'text') {
            if (cfg.text != null) txtText.value = String(cfg.text);
            if (cfg.pps != null) txtPps.value = String(cfg.pps);
            if (cfg.letter_spacing != null) txtSpacing.value = String(cfg.letter_spacing);
          }
          if (id === 'simplex-noise-js') {
            if (cfg.scale != null) snScale.value = String(cfg.scale);
            if (cfg.step != null) snStep.value = String(cfg.step);
            if (cfg.threshold != null) snThreshold.value = String(cfg.threshold);
            if (cfg.seed != null) snSeed.value = String(cfg.seed);
            if (cfg.invert != null) snInvert.checked = !!cfg.invert;
          }
        } catch {}
      }

      refreshSources();
      refreshConfig();
      refreshStats();
      setInterval(refreshSources, 2000);
      setInterval(refreshStats, 2000);
      // Preview refresh is managed by setPreviewFps() invoked from refreshConfig()
    </script>
  </body>
  </html>
